name: Weekly Backtest

on:
  schedule:
    # Run at 06:00 UTC on Sundays (08:00 Estonian time)
    - cron: '0 6 * * 0'
  workflow_dispatch:
    inputs:
      mp_slug:
        description: 'Specific MP slug (optional, tests all if empty)'
        required: false
        type: string
      max_votes:
        description: 'Max votes per MP'
        required: false
        default: '100'
        type: string

env:
  NODE_VERSION: '20'

jobs:
  backtest:
    runs-on: ubuntu-latest
    timeout-minutes: 240  # 4 hours max

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run backtests
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          VOYAGE_API_KEY: ${{ secrets.VOYAGE_API_KEY }}
        run: |
          MP_SLUG="${{ github.event.inputs.mp_slug }}"
          MAX_VOTES="${{ github.event.inputs.max_votes || '100' }}"

          if [ -n "$MP_SLUG" ]; then
            npx tsx scripts/run-backtest.ts --mp="$MP_SLUG" --max-votes="$MAX_VOTES"
          else
            npx tsx scripts/run-backtest.ts --max-votes="$MAX_VOTES"
          fi

      - name: Report accuracy summary
        if: always()
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
        run: |
          echo "=== Accuracy Summary ==="
          npx tsx -e "
            import 'dotenv/config';
            import { getCollection, closeConnection } from './src/lib/data/mongodb';
            async function main() {
              const mps = getCollection('mps');
              const results = await mps.find({ 'backtest.accuracy': { \$exists: true } })
                .project({ slug: 1, 'backtest.accuracy.overall': 1, 'backtest.sampleSize': 1 })
                .sort({ 'backtest.accuracy.overall': -1 })
                .toArray();
              console.log('MP Accuracy Results:');
              for (const mp of results) {
                console.log(\`  \${mp.slug}: \${mp.backtest?.accuracy?.overall || 0}% (n=\${mp.backtest?.sampleSize || 0})\`);
              }
              const avgAccuracy = results.reduce((sum, mp) => sum + (mp.backtest?.accuracy?.overall || 0), 0) / results.length;
              console.log(\`\\nAverage accuracy: \${avgAccuracy.toFixed(1)}%\`);
              await closeConnection();
            }
            main();
          "
